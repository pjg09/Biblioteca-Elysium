@startuml Sistema_Biblioteca_SOLID

' ========================================
' CONFIGURACIÓN Y ESTILOS
' ========================================

skinparam classAttributeIconSize 0
skinparam roundcorner 10
skinparam shadowing false

skinparam class {
    BackgroundColor<<abstract>> LightYellow
    BackgroundColor<<interface>> LightBlue
    BackgroundColor<<exception>> LightCoral
    BackgroundColor<<enumeration>> LightGreen
    BorderColor Black
    ArrowColor Black
}

' ========================================
' ENTIDADES DEL DOMINIO - MATERIALES
' ========================================

abstract class Material {
    -string id
    -string titulo
    -string autor
    -EstadoMaterial estado
    -DateTime fechaAdquisicion
    -decimal valorReposicion
    #ValidarEstado() : bool
    +GetId() : string
    +GetTitulo() : string
    +GetEstado() : EstadoMaterial
    +SetEstado(nuevoEstado)
    +{abstract} ObtenerInformacion() : string
    +{abstract} EsPrestable() : bool
    +{abstract} CalcularValorMultaDiaria() : decimal
}

class Libro {
    -string isbn
    -int numeroPaginas
    -bool esBestSeller
    -bool esReferencia
    +GetISBN() : string
    +EsBestSeller() : bool
    +ObtenerInformacion() : string
    +EsPrestable() : bool
    +CalcularValorMultaDiaria() : decimal
}

class DVD {
    -string codigo
    -int duracionMinutos
    -string director
    +GetCodigo() : string
    +ObtenerInformacion() : string
    +EsPrestable() : bool
    +CalcularValorMultaDiaria() : decimal
}

class Revista {
    -string issn
    -int numeroEdicion
    -bool esUltimoNumero
    +GetISSN() : string
    +EsUltimoNumero() : bool
    +ObtenerInformacion() : string
    +EsPrestable() : bool
    +CalcularValorMultaDiaria() : decimal
}

class EBook {
    -string urlDescarga
    -int licenciasDisponibles
    -DateTime fechaVencimientoLicencia
    +GetLicenciasDisponibles() : int
    +TieneLicenciasDisponibles() : bool
    +ObtenerInformacion() : string
    +EsPrestable() : bool
    +CalcularValorMultaDiaria() : decimal
}

Material <|-- Libro
Material <|-- DVD
Material <|-- Revista
Material <|-- EBook

' ========================================
' ENTIDADES DEL DOMINIO - USUARIOS
' ========================================

abstract class Usuario {
    -string id
    -string nombre
    -string email
    -EstadoUsuario estado
    -decimal multaAcumulada
    -DateTime fechaRegistro
    #ValidarCredenciales() : bool
    +GetId() : string
    +GetNombre() : string
    +GetEstado() : EstadoUsuario
    +GetMultaAcumulada() : decimal
    +SetEstado(nuevoEstado)
    +AgregarMulta(monto)
    +EstaActivo() : bool
    +{abstract} ObtenerLimiteMateriales() : int
    +{abstract} ObtenerDiasPrestamo() : int
    +{abstract} TieneDescuentoMulta() : bool
}

class Estudiante {
    -string carrera
    -int semestre
    +GetCarrera() : string
    +ObtenerLimiteMateriales() : int
    +ObtenerDiasPrestamo() : int
    +TieneDescuentoMulta() : bool
}

class Profesor {
    -string departamento
    -string universidad
    +GetDepartamento() : string
    +ObtenerLimiteMateriales() : int
    +ObtenerDiasPrestamo() : int
    +TieneDescuentoMulta() : bool
}

class Investigador {
    -string lineaInvestigacion
    -string institucion
    +GetLineaInvestigacion() : string
    +ObtenerLimiteMateriales() : int
    +ObtenerDiasPrestamo() : int
    +TieneDescuentoMulta() : bool
    +PuedeAccederColeccionEspecial() : bool
}

class PublicoGeneral {
    -string direccion
    -string nombreFiador
    +GetFiador() : string
    +ObtenerLimiteMateriales() : int
    +ObtenerDiasPrestamo() : int
    +TieneDescuentoMulta() : bool
}

Usuario <|-- Estudiante
Usuario <|-- Profesor
Usuario <|-- Investigador
Usuario <|-- PublicoGeneral

' ========================================
' TRANSACCIONES
' ========================================

abstract class Transaccion {
    -string id
    -string idUsuario
    -string idMaterial
    -DateTime fechaCreacion
    -EstadoTransaccion estado
    #ValidarTransaccion() : bool
    +GetId() : string
    +GetIdUsuario() : string
    +GetIdMaterial() : string
    +GetEstado() : EstadoTransaccion
    +SetEstado(nuevoEstado)
    +{abstract} EsActiva() : bool
    +{abstract} PuedeModificarse() : bool
}

abstract class Prestamo {
    -DateTime fechaPrestamo
    -DateTime fechaDevolucionEsperada
    -DateTime fechaDevolucionReal
    -int renovacionesUsadas
    -int maximoRenovaciones
    #CalcularDiasActivos() : int
    +GetFechaPrestamo() : DateTime
    +GetFechaDevolucionEsperada() : DateTime
    +SetFechaDevolucionReal(fecha)
    +CalcularDiasRetraso() : int
    +EstaVencido() : bool
    +PuedeRenovarse() : bool
    +RegistrarRenovacion()
    +EsActiva() : bool
    +PuedeModificarse() : bool
    +{abstract} ObtenerTipoPrestamo() : string
}

class PrestamoNormal {
    -string ubicacionBiblioteca
    +GetUbicacion() : string
    +EsActiva() : bool
    +ObtenerTipoPrestamo() : string
}

class PrestamoInterbibliotecario {
    -string bibliotecaOrigen
    -string bibliotecaDestino
    -decimal costoTransferencia
    +GetBibliotecaOrigen() : string
    +GetBibliotecaDestino() : string
    +CalcularCostoTotal() : decimal
    +EsActiva() : bool
    +ObtenerTipoPrestamo() : string
}

class PrestamoDigital {
    -string urlAcceso
    -DateTime fechaVencimientoAutomatico
    -bool descargado
    +GetUrlAcceso() : string
    +EstaDescargado() : bool
    +VencimientoAutomatico()
    +EsActiva() : bool
    +ObtenerTipoPrestamo() : string
}

Transaccion <|-- Prestamo
Prestamo <|-- PrestamoNormal
Prestamo <|-- PrestamoInterbibliotecario
Prestamo <|-- PrestamoDigital

abstract class Reserva {
    -DateTime fechaReserva
    -DateTime fechaNotificacion
    -DateTime fechaExpiracion
    -int posicionCola
    -int horasParaRecoger
    +GetFechaReserva() : DateTime
    +GetPosicionCola() : int
    +SetPosicionCola(posicion)
    +HaExpirado() : bool
    +TiempoRestanteParaRecoger() : int
    +EsActiva() : bool
    +PuedeModificarse() : bool
    +{abstract} ObtenerTipoReserva() : string
}

class ReservaNormal {
    -string ubicacionBiblioteca
    +GetUbicacion() : string
    +ObtenerTipoReserva() : string
}

class ReservaInterbibliotecaria {
    -string bibliotecaDestino
    -bool requiereTransferencia
    +GetBibliotecaDestino() : string
    +RequiereTransferencia() : bool
    +ObtenerTipoReserva() : string
}

Transaccion <|-- Reserva
Reserva <|-- ReservaNormal
Reserva <|-- ReservaInterbibliotecaria

' ========================================
' MULTAS EXTENSIBLES
' ========================================

abstract class Multa {
    -string id
    -string idPrestamo
    -string idUsuario
    -DateTime fechaGeneracion
    -DateTime fechaPago
    -EstadoMulta estado
    -string motivo
    #CalcularMontoBase() : decimal
    +GetId() : string
    +GetMonto() : decimal
    +GetEstado() : EstadoMulta
    +GetMotivo() : string
    +SetFechaPago(fecha)
    +{abstract} CalcularMontoTotal() : decimal
    +{abstract} AplicarDescuento(usuario) : decimal
    +RegistrarPago() : Resultado
    +EsPendiente() : bool
}

class MultaPorRetraso {
    -int diasRetraso
    -decimal tarifaDiaria
    +GetDiasRetraso() : int
    +CalcularMontoBase() : decimal
    +CalcularMontoTotal() : decimal
    +AplicarDescuento(usuario) : decimal
}

class MultaPorDano {
    -List<Dano> danos
    -decimal costoReparacion
    -NivelGravedad gravedadMaxima
    +GetDanos() : List<Dano>
    +CalcularMontoBase() : decimal
    +CalcularMontoTotal() : decimal
    +AplicarDescuento(usuario) : decimal
    +RequiereReemplazo() : bool
}

class MultaPorPerdida {
    -decimal valorMaterial
    -decimal porcentajeRecargo
    -bool materialRecuperable
    +GetValorMaterial() : decimal
    +CalcularMontoBase() : decimal
    +CalcularMontoTotal() : decimal
    +AplicarDescuento(usuario) : decimal
}

class MultaAdministrativa {
    -string razon
    -decimal montoFijo
    -bool esApelable
    +GetRazon() : string
    +EsApelable() : bool
    +CalcularMontoBase() : decimal
    +CalcularMontoTotal() : decimal
    +AplicarDescuento(usuario) : decimal
}

Multa <|-- MultaPorRetraso
Multa <|-- MultaPorDano
Multa <|-- MultaPorPerdida
Multa <|-- MultaAdministrativa

note right of Multa
  Abstracción extensible.
  Nuevos tipos de multa
  = nuevas clases hijas.
  Ej: MultaPorUsoIndebido
end note

' ========================================
' RELACIONES ENTRE ENTIDADES
' ========================================

Usuario "1" -- "0..*" Transaccion : realiza
Material "1" -- "0..*" Transaccion : involucrado
Prestamo "1" -- "0..*" Multa : puede generar
Usuario "1" -- "0..*" Multa : recibe
MultaPorDano "1" *-- "1..*" Dano : tiene

' ========================================
' EXCEPCIONES PERSONALIZADAS
' ========================================

class BibliotecaException <<exception>> {
    -string mensaje
    -string codigo
    -object detalles
    +GetMensaje() : string
    +GetCodigo() : string
    +GetDetalles() : object
}

class MaterialNoDisponibleException <<exception>> {
    -string idMaterial
    -EstadoMaterial estadoActual
    -DateTime fechaDisponibilidadEstimada
    +GetIdMaterial() : string
    +GetEstadoActual() : EstadoMaterial
    +GetFechaEstimada() : DateTime
}

class UsuarioBloqueadoException <<exception>> {
    -string idUsuario
    -List<string> motivosBloqueo
    -decimal multaPendiente
    +GetIdUsuario() : string
    +GetMotivos() : List<string>
    +GetMultaPendiente() : decimal
}

class LimiteExcedidoException <<exception>> {
    -string idUsuario
    -int limiteMaximo
    -int cantidadActual
    +GetIdUsuario() : string
    +GetLimiteMaximo() : int
    +GetCantidadActual() : int
}

class MaterialNoEncontradoException <<exception>> {
    -string idMaterial
    -string criterio
    +GetIdMaterial() : string
    +GetCriterio() : string
}

class OperacionNoPermitidaException <<exception>> {
    -string operacion
    -string razon
    +GetOperacion() : string
    +GetRazon() : string
}

BibliotecaException <|-- MaterialNoDisponibleException
BibliotecaException <|-- UsuarioBloqueadoException
BibliotecaException <|-- LimiteExcedidoException
BibliotecaException <|-- MaterialNoEncontradoException
BibliotecaException <|-- OperacionNoPermitidaException

note top of BibliotecaException
  Excepciones específicas del dominio.
  Permiten manejo granular de errores.
end note

' ========================================
' INTERFACES DE SERVICIOS
' ========================================

interface IDisponibilidadService {
    +VerificarDisponibilidad(idMaterial : string) : bool
    +ObtenerEstadoActual(idMaterial : string) : EstadoMaterial
    +ObtenerFechaDisponibilidadEstimada(idMaterial : string) : DateTime
    +ContarCopiasDisponibles(idMaterial : string) : int
    +MaterialEsPrestable(idMaterial : string) : bool
}

interface ILimitePrestamoService {
    +ValidarLimite(idUsuario : string) : ResultadoValidacion
    +ObtenerLimiteActual(idUsuario : string) : int
    +CantidadActualPrestada(idUsuario : string) : int
    +EspacioDisponible(idUsuario : string) : int
}

interface IValidadorReglasService {
    +ValidarPrestamo(idUsuario : string, idMaterial : string) : ResultadoValidacion
    +ValidarReserva(idUsuario : string, idMaterial : string) : ResultadoValidacion
    +ValidarRenovacion(idPrestamo : string) : ResultadoValidacion
    +ValidarDevolucion(idPrestamo : string) : ResultadoValidacion
}

interface IPoliticaTiempoService {
    +CalcularDiasPrestamo(idMaterial : string, idUsuario : string) : int
    +ObtenerFechaDevolucion(fechaPrestamo : DateTime, idMaterial : string, idUsuario : string) : DateTime
    +PuedeExtenderPlazo(idPrestamo : string) : bool
    +CalcularDiasExtension(idPrestamo : string) : int
}

interface ICalculadorMultaService {
    +CalcularMultaPorRetraso(idPrestamo : string, fechaActual : DateTime) : Multa
    +CalcularMultaPorDano(idMaterial : string, evaluacion : Evaluacion) : Multa
    +CalcularMultaPorPerdida(idMaterial : string) : Multa
    +CrearMultaAdministrativa(idUsuario : string, razon : string, monto : decimal) : Multa
}

interface IGestorBloqueoService {
    +VerificarSiDebeBloquear(idUsuario : string) : ResultadoValidacion
    +BloquearUsuario(idUsuario : string, motivo : string) : Resultado
    +DesbloquearUsuario(idUsuario : string) : Resultado
    +ObtenerMotivosBloqueo(idUsuario : string) : List<string>
}

interface IReservaService {
    +CrearReserva(idUsuario : string, idMaterial : string, tipoReserva : string) : Resultado
    +CancelarReserva(idReserva : string) : Resultado
    +ObtenerPosicionEnCola(idReserva : string) : int
    +NotificarDisponibilidad(idReserva : string) : Resultado
    +ProcesarExpiracion(idReserva : string) : Resultado
}

interface IRenovacionService {
    +ValidarRenovacion(idPrestamo : string) : ResultadoValidacion
    +RenovarPrestamo(idPrestamo : string) : Resultado
    +ObtenerRenovacionesDisponibles(idPrestamo : string) : int
    +CalcularNuevaFechaDevolucion(idPrestamo : string) : DateTime
}

interface IPrestamoService {
    +RegistrarPrestamo(idUsuario : string, idMaterial : string, tipoPrestamo : string) : Resultado
    +ObtenerPrestamosActivos(idUsuario : string) : List<Prestamo>
    +ObtenerHistorialPrestamos(idUsuario : string) : List<Prestamo>
}

interface IDevolucionService {
    +RegistrarDevolucion(idPrestamo : string, evaluacion : Evaluacion) : Resultado
    +ProcesarSiguienteReserva(idMaterial : string) : Resultado
}

interface IInspeccionMaterialService {
    +InspeccionarMaterial(idMaterial : string) : Evaluacion
    +DeterminarDanos(idMaterial : string) : List<Dano>
    +EvaluarUsabilidad(idMaterial : string) : bool
}

interface INotificacionService {
    +EnviarNotificacion(idUsuario : string, mensaje : string, canal : string) : Resultado
    +EnviarRecordatorioVencimiento(idPrestamo : string) : Resultado
    +EnviarAlertaMulta(idUsuario : string, idMulta : string) : Resultado
    +EnviarConfirmacionReserva(idReserva : string) : Resultado
}

' ========================================
' IMPLEMENTACIONES - SERVICIOS
' ========================================

class DisponibilidadStandardService {
    -IRepositorio<Material> repoMaterial
    -IRepositorio<Prestamo> repoPrestamo
    +VerificarDisponibilidad(idMaterial : string) : bool
    +ObtenerEstadoActual(idMaterial : string) : EstadoMaterial
    +ContarCopiasDisponibles(idMaterial : string) : int
    +MaterialEsPrestable(idMaterial : string) : bool
}

class LimitePorTipoUsuarioService {
    -IRepositorio<Usuario> repoUsuario
    -IRepositorio<Prestamo> repoPrestamo
    +ValidarLimite(idUsuario : string) : ResultadoValidacion
    +ObtenerLimiteActual(idUsuario : string) : int
    +CantidadActualPrestada(idUsuario : string) : int
    +EspacioDisponible(idUsuario : string) : int
    -ObtenerLimiteSegunTipo(usuario : Usuario) : int
}

class ValidadorReglasService {
    -ILimitePrestamoService limiteService
    -IDisponibilidadService disponibilidadService
    -IGestorBloqueoService bloqueoService
    -List<IReglaValidacion> reglas
    +ValidarPrestamo(idUsuario : string, idMaterial : string) : ResultadoValidacion
    +ValidarReserva(idUsuario : string, idMaterial : string) : ResultadoValidacion
    +ValidarRenovacion(idPrestamo : string) : ResultadoValidacion
    -AplicarReglas(contexto) : ResultadoValidacion
    -ProcesarResultados(resultados) : ResultadoValidacion
}

class PoliticaTiempoPorTipoService {
    -IRepositorio<Material> repoMaterial
    -IRepositorio<Usuario> repoUsuario
    +CalcularDiasPrestamo(idMaterial : string, idUsuario : string) : int
    +ObtenerFechaDevolucion(fechaPrestamo : DateTime, idMaterial : string, idUsuario : string) : DateTime
    -ObtenerDiasSegunTipo(material : Material, usuario : Usuario) : int
}

class CalculadorMultaService {
    -IRepositorio<Prestamo> repoPrestamo
    -IRepositorio<Material> repoMaterial
    -IRepositorio<Usuario> repoUsuario
    -IRepositorio<Multa> repoMulta
    +CalcularMultaPorRetraso(idPrestamo : string, fechaActual : DateTime) : Multa
    +CalcularMultaPorDano(idMaterial : string, evaluacion : Evaluacion) : Multa
    +CalcularMultaPorPerdida(idMaterial : string) : Multa
    +CrearMultaAdministrativa(idUsuario : string, razon : string, monto : decimal) : Multa
    -AplicarDescuentoSiAplica(multa : Multa, usuario : Usuario) : decimal
}

class GestorBloqueoService {
    -IRepositorio<Usuario> repoUsuario
    -IRepositorio<Multa> repoMulta
    -decimal UMBRAL_BLOQUEO_MULTA
    +VerificarSiDebeBloquear(idUsuario : string) : ResultadoValidacion
    +BloquearUsuario(idUsuario : string, motivo : string) : Resultado
    +DesbloquearUsuario(idUsuario : string) : Resultado
    +ObtenerMotivosBloqueo(idUsuario : string) : List<string>
    -CalcularMultaTotal(idUsuario : string) : decimal
}

class RenovacionService {
    -IRepositorio<Prestamo> repoPrestamo
    -IRepositorio<Reserva> repoReserva
    -IValidadorReglasService validador
    -IPoliticaTiempoService politicaTiempo
    +ValidarRenovacion(idPrestamo : string) : ResultadoValidacion
    +RenovarPrestamo(idPrestamo : string) : Resultado
    +ObtenerRenovacionesDisponibles(idPrestamo : string) : int
    +CalcularNuevaFechaDevolucion(idPrestamo : string) : DateTime
    -TieneReservasPendientes(idMaterial : string) : bool
}

class ReservaService {
    -IRepositorio<Reserva> repoReserva
    -IRepositorio<Material> repoMaterial
    -IDisponibilidadService disponibilidad
    -IValidadorReglasService validador
    -INotificacionService notificador
    +CrearReserva(idUsuario : string, idMaterial : string, tipoReserva : string) : Resultado
    +CancelarReserva(idReserva : string) : Resultado
    +ObtenerPosicionEnCola(idReserva : string) : int
    +NotificarDisponibilidad(idReserva : string) : Resultado
    -CrearReservaSegunTipo(tipo : string, datos) : Reserva
}

class PrestamoService {
    -IValidadorReglasService validador
    -IDisponibilidadService disponibilidad
    -IPoliticaTiempoService politicaTiempo
    -IRepositorio<Prestamo> repoPrestamo
    -IRepositorio<Material> repoMaterial
    -INotificacionService notificador
    +RegistrarPrestamo(idUsuario : string, idMaterial : string, tipoPrestamo : string) : Resultado
    +ObtenerPrestamosActivos(idUsuario : string) : List<Prestamo>
    +ObtenerHistorialPrestamos(idUsuario : string) : List<Prestamo>
    -CrearPrestamoSegunTipo(tipo : string, datos) : Prestamo
    -ValidarYProcesar(idUsuario : string, idMaterial : string) : ResultadoValidacion
}

class DevolucionService {
    -IInspeccionMaterialService inspeccion
    -ICalculadorMultaService calculadorMulta
    -IRepositorio<Prestamo> repoPrestamo
    -IRepositorio<Material> repoMaterial
    -IReservaService reservas
    -INotificacionService notificador
    -IGestorBloqueoService gestorBloqueo
    +RegistrarDevolucion(idPrestamo : string, evaluacion : Evaluacion) : Resultado
    +ProcesarSiguienteReserva(idMaterial : string) : Resultado
    -ProcesarMultaSiAplica(idPrestamo : string, evaluacion : Evaluacion) : Multa
    -VerificarYBloquearSiAplica(idUsuario : string)
}

class InspeccionMaterialService {
    -IRepositorio<Material> repoMaterial
    -List<ICriterioInspeccion> criterios
    +InspeccionarMaterial(idMaterial : string) : Evaluacion
    +DeterminarDanos(idMaterial : string) : List<Dano>
    +EvaluarUsabilidad(idMaterial : string) : bool
    -AplicarCriterios(material : Material) : Evaluacion
}

class NotificacionEmailService {
    -string servidorSMTP
    -string emailBiblioteca
    +EnviarNotificacion(idUsuario : string, mensaje : string, canal : string) : Resultado
    +EnviarRecordatorioVencimiento(idPrestamo : string) : Resultado
    -ConstruirMensajeEmail(template : string, datos) : string
}

' ========================================
' RELACIONES IMPLEMENTACIONES
' ========================================

IDisponibilidadService <|.. DisponibilidadStandardService
ILimitePrestamoService <|.. LimitePorTipoUsuarioService
IValidadorReglasService <|.. ValidadorReglasService
IPoliticaTiempoService <|.. PoliticaTiempoPorTipoService
ICalculadorMultaService <|.. CalculadorMultaService
IGestorBloqueoService <|.. GestorBloqueoService
IRenovacionService <|.. RenovacionService
IReservaService <|.. ReservaService
IPrestamoService <|.. PrestamoService
IDevolucionService <|.. DevolucionService
IInspeccionMaterialService <|.. InspeccionMaterialService
INotificacionService <|.. NotificacionEmailService

ValidadorReglasService --> ILimitePrestamoService : usa
ValidadorReglasService --> IDisponibilidadService : usa
ValidadorReglasService --> IGestorBloqueoService : usa

RenovacionService --> IValidadorReglasService : usa
RenovacionService --> IPoliticaTiempoService : usa

ReservaService --> IDisponibilidadService : usa
ReservaService --> IValidadorReglasService : usa
ReservaService --> INotificacionService : usa

PrestamoService --> IValidadorReglasService : usa
PrestamoService --> IDisponibilidadService : usa
PrestamoService --> IPoliticaTiempoService : usa
PrestamoService --> INotificacionService : usa

DevolucionService --> IInspeccionMaterialService : usa
DevolucionService --> ICalculadorMultaService : usa
DevolucionService --> IReservaService : usa
DevolucionService --> INotificacionService : usa
DevolucionService --> IGestorBloqueoService : usa

LimitePorTipoUsuarioService --> Usuario : lee polimórficamente
PoliticaTiempoPorTipoService --> Material : lee polimórficamente
PoliticaTiempoPorTipoService --> Usuario : lee polimórficamente
CalculadorMultaService --> Usuario : lee para descuentos
CalculadorMultaService --> Material : lee para valoración

DisponibilidadStandardService ..> MaterialNoDisponibleException : lanza
LimitePorTipoUsuarioService ..> LimiteExcedidoException : lanza
GestorBloqueoService ..> UsuarioBloqueadoException : lanza
RenovacionService ..> OperacionNoPermitidaException : lanza

LimitePorTipoUsuarioService ..> ResultadoValidacion : retorna
ValidadorReglasService ..> ResultadoValidacion : retorna
GestorBloqueoService ..> ResultadoValidacion : retorna
RenovacionService ..> ResultadoValidacion : retorna

PrestamoService ..> Resultado : retorna
DevolucionService ..> Resultado : retorna
ReservaService ..> Resultado : retorna
RenovacionService ..> Resultado : retorna
NotificacionEmailService ..> Resultado : retorna

CalculadorMultaService ..> MultaPorRetraso : crea
CalculadorMultaService ..> MultaPorDano : crea
CalculadorMultaService ..> MultaPorPerdida : crea
CalculadorMultaService ..> MultaAdministrativa : crea
CalculadorMultaService ..> Evaluacion : recibe

InspeccionMaterialService ..> Evaluacion : retorna
InspeccionMaterialService ..> Dano : retorna lista

' ========================================
' REGLAS DE VALIDACIÓN
' ========================================

interface IReglaValidacion {
    +Validar(contexto) : ResultadoValidacion
    +ObtenerPrioridad() : int
}

class ReglaUsuarioActivo {
    +Validar(contexto) : ResultadoValidacion
    +ObtenerPrioridad() : int
}

class ReglaMaterialDisponible {
    +Validar(contexto) : ResultadoValidacion
    +ObtenerPrioridad() : int
}

class ReglaLimiteNoExcedido {
    -ILimitePrestamoService limiteService
    +Validar(contexto) : ResultadoValidacion
    +ObtenerPrioridad() : int
}

IReglaValidacion <|.. ReglaUsuarioActivo
IReglaValidacion <|.. ReglaMaterialDisponible
IReglaValidacion <|.. ReglaLimiteNoExcedido

ValidadorReglasService --> IReglaValidacion : usa lista de
ReglaLimiteNoExcedido --> ILimitePrestamoService : usa
ReglaUsuarioActivo ..> ResultadoValidacion : retorna
ReglaMaterialDisponible ..> ResultadoValidacion : retorna
ReglaLimiteNoExcedido ..> ResultadoValidacion : retorna

' ========================================
' REPOSITORIO GENÉRICO
' ========================================

interface "IRepositorio<T>" as IRepositorio {
    +Agregar(entidad : T) : Resultado
    +Actualizar(entidad : T) : Resultado
    +Eliminar(id : string) : Resultado
    +ObtenerPorId(id : string) : T
    +ObtenerTodos() : List<T>
    +Existe(id : string) : bool
}

class "RepositorioEnMemoria<T>" as RepositorioEnMemoria {
    -Dictionary<string, T> almacenamiento
    +Agregar(entidad : T) : Resultado
    +Actualizar(entidad : T) : Resultado
    +Eliminar(id : string) : Resultado
    +ObtenerPorId(id : string) : T
    +ObtenerTodos() : List<T>
    +Existe(id : string) : bool
    +Limpiar()
}

IRepositorio <|.. RepositorioEnMemoria

RepositorioEnMemoria ..> MaterialNoEncontradoException : lanza

note right of IRepositorio
  Repositorio genérico.
  Todos los repositorios específicos
  usan esta implementación en memoria.
  Fácil cambiar a SQL después.
end note

' ========================================
' OBJETOS DE VALOR Y RESULTADOS
' ========================================

class ResultadoValidacion {
    -bool esValido
    -List<string> errores
    -List<string> advertencias
    -string mensajePrincipal
    +EsValido() : bool
    +GetErrores() : List<string>
    +GetAdvertencias() : List<string>
    +GetMensaje() : string
    +AgregarError(error : string)
    +AgregarAdvertencia(advertencia : string)
    +Combinar(otroResultado : ResultadoValidacion) : ResultadoValidacion
    +{static} Valido() : ResultadoValidacion
    +{static} Invalido(errores : List<string>) : ResultadoValidacion
}

class Resultado {
    -bool exito
    -string mensaje
    -object data
    -List<string> errores
    +GetExito() : bool
    +GetMensaje() : string
    +GetData() : object
    +GetData<T>() : T
    +GetErrores() : List<string>
    +{static} Exitoso(mensaje : string, data : object) : Resultado
    +{static} Fallido(mensaje : string, errores : List<string>) : Resultado
    +{static} DesdeValidacion(validacion : ResultadoValidacion) : Resultado
}

class Evaluacion {
    -bool materialUsable
    -List<Dano> danosEncontrados
    -decimal costoReparacion
    -string observaciones
    +EsUsable() : bool
    +GetDanos() : List<Dano>
    +GetCostoReparacion() : decimal
    +TieneDanos() : bool
    +RequiereReparacion() : bool
    +RequiereReemplazo() : bool
}

class Dano {
    -string descripcion
    -NivelGravedad gravedad
    -decimal costoReparacion
    -TipoDano tipo
    +GetDescripcion() : string
    +GetGravedad() : NivelGravedad
    +GetCostoReparacion() : decimal
    +GetTipo() : TipoDano
    +EsReparable() : bool
}

Evaluacion "1" *-- "0..*" Dano : contiene

note left of ResultadoValidacion
  Usado por servicios de validación.
  Permite acumular errores/advertencias
  y combinar múltiples validaciones.
end note

' ========================================
' ENUMERACIONES
' ========================================

enum EstadoMaterial {
    DISPONIBLE
    PRESTADO
    RESERVADO
    EN_REPARACION
    PERDIDO
    DADO_DE_BAJA
}

enum EstadoUsuario {
    ACTIVO
    BLOQUEADO_MULTA
    BLOQUEADO_PERDIDA
    SUSPENDIDO
    INACTIVO
}

enum EstadoTransaccion {
    ACTIVA
    COMPLETADA
    CANCELADA
    EXPIRADA
}

enum EstadoMulta {
    PENDIENTE
    PAGADA
    CONDONADA
    EN_PROCESO_COBRO
}

enum NivelGravedad {
    LEVE
    MODERADO
    GRAVE
    IRREPARABLE
}

enum TipoDano {
    PAGINAS_RASGADAS
    MANCHAS
    CUBIERTA_DANADA
    RAYONES
    NO_FUNCIONAL
    OTRO
}

Dano --> NivelGravedad : tiene
Dano --> TipoDano : clasifica

@enduml