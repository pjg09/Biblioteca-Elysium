@startuml Sistema_Biblioteca_SOLID_FINAL

'ESTILOS


skinparam classAttributeIconSize 0
skinparam roundcorner 10
skinparam shadowing false

skinparam class {
    BackgroundColor<<abstract>> LightYellow
    BackgroundColor<<interface>> LightBlue
    BackgroundColor<<exception>> LightCoral
    BackgroundColor<<enumeration>> LightGreen
    BackgroundColor<<service>> Wheat
    BorderColor Black
    ArrowColor Black
}

' ENTIDADES DEL DOMINIO 

abstract class Material {
    -string id
    -string titulo
    -string autor
    -TipoMaterial tipo
    -EstadoMaterial estado
    -DateTime fechaAdquisicion
    +GetId() : string
    +GetTitulo() : string
    +GetAutor() : string
    +GetTipo() : TipoMaterial
    +GetEstado() : EstadoMaterial
    +SetEstado(nuevoEstado)
}

class Libro {
    -string isbn
    -int numeroPaginas
    -bool esBestSeller
    -bool esReferencia
    +GetISBN() : string
    +EsBestSeller() : bool
    +EsReferencia() : bool
}

class DVD {
    -string codigo
    -int duracionMinutos
    -string director
    +GetCodigo() : string
}

class Revista {
    -string issn
    -int numeroEdicion
    -bool esUltimoNumero
    +GetISSN() : string
    +EsUltimoNumero() : bool
}

class EBook {
    -string urlDescarga
    -int licenciasDisponibles
    -DateTime fechaVencimientoLicencia
    +GetLicenciasDisponibles() : int
    +TieneLicenciasDisponibles() : bool
}

Material <|-- Libro
Material <|-- DVD
Material <|-- Revista
Material <|-- EBook

note right of Material
  SRP: Material es SOLO datos.
  - NO calcula multas
  - NO decide si es prestable
  Los SERVICIOS tienen esa lógica.
end note


abstract class Usuario {
    -string id
    -string nombre
    -string email
    -TipoUsuario tipo
    -EstadoUsuario estado
    -DateTime fechaRegistro
    +GetId() : string
    +GetNombre() : string
    +GetEmail() : string
    +GetTipo() : TipoUsuario
    +GetEstado() : EstadoUsuario
    +SetEstado(nuevoEstado)
}

class Estudiante {
    -string carrera
    -int semestre
    -string universidad
    +GetCarrera() : string
}

class Profesor {
    -string departamento
    -string universidad
    -string especialidad
    +GetDepartamento() : string
}

class Investigador {
    -string lineaInvestigacion
    -string institucion
    +GetLineaInvestigacion() : string
}

class PublicoGeneral {
    -string direccion
    -string nombreFiador
    +GetFiador() : string
}

Usuario <|-- Estudiante
Usuario <|-- Profesor
Usuario <|-- Investigador
Usuario <|-- PublicoGeneral

note right of Usuario
  SRP: Usuario es SOLO datos.
  - NO tiene límites hardcoded
  - NO calcula políticas
  Los SERVICIOS leen el tipo y aplican reglas.
end note

' TRANSACCIONES


abstract class Transaccion {
    -string id
    -string idUsuario
    -string idMaterial
    -DateTime fechaCreacion
    -EstadoTransaccion estado
    +GetId() : string
    +GetIdUsuario() : string
    +GetIdMaterial() : string
    +GetEstado() : EstadoTransaccion
    +SetEstado(nuevoEstado)
}

abstract class Prestamo {
    -DateTime fechaPrestamo
    -DateTime fechaDevolucionEsperada
    -DateTime fechaDevolucionReal
    -int renovacionesUsadas
    +GetFechaPrestamo() : DateTime
    +GetFechaDevolucionEsperada() : DateTime
    +GetFechaDevolucionReal() : DateTime
    +SetFechaDevolucionReal(fecha)
    +GetRenovacionesUsadas() : int
    +IncrementarRenovaciones()
}

class PrestamoNormal {
    -string ubicacionBiblioteca
    +GetUbicacion() : string
}

class PrestamoInterbibliotecario {
    -string bibliotecaOrigen
    -string bibliotecaDestino
    -decimal costoTransferencia
    +GetBibliotecaOrigen() : string
    +GetBibliotecaDestino() : string
    +GetCostoTransferencia() : decimal
}

Transaccion <|-- Prestamo
Prestamo <|-- PrestamoNormal
Prestamo <|-- PrestamoInterbibliotecario


abstract class Reserva {
    -DateTime fechaReserva
    -DateTime fechaNotificacion
    -DateTime fechaExpiracion
    -int posicionCola
    +GetFechaReserva() : DateTime
    +GetPosicionCola() : int
    +SetPosicionCola(posicion)
}

class ReservaNormal {
    -string ubicacionBiblioteca
    +GetUbicacion() : string
}

class ReservaInterbibliotecaria {
    -string bibliotecaDestino
    +GetBibliotecaDestino() : string
}

Transaccion <|-- Reserva
Reserva <|-- ReservaNormal
Reserva <|-- ReservaInterbibliotecaria

' MULTAS 

abstract class Multa {
    -string id
    -string idPrestamo
    -string idUsuario
    -DateTime fechaGeneracion
    -DateTime fechaPago
    -EstadoMulta estado
    -string motivo
    +GetId() : string
    +GetEstado() : EstadoMulta
    +GetMotivo() : string
    +SetFechaPago(fecha)
    +{abstract} CalcularMontoTotal() : decimal
    +EsPendiente() : bool
}

class MultaPorRetraso {
    -int diasRetraso
    -decimal tarifaDiaria
    +GetDiasRetraso() : int
    +CalcularMontoTotal() : decimal
}

class MultaPorDano {
    -List<Dano> danos
    +GetDanos() : List<Dano>
    +CalcularMontoTotal() : decimal
}

class MultaPorPerdida {
    -decimal valorMaterial
    -decimal porcentajeRecargo
    +GetValorMaterial() : decimal
    +CalcularMontoTotal() : decimal
}

class MultaAdministrativa {
    -decimal montoFijo
    +GetMontoFijo() : decimal
    +CalcularMontoTotal() : decimal
}

Multa <|-- MultaPorRetraso
Multa <|-- MultaPorDano
Multa <|-- MultaPorPerdida
Multa <|-- MultaAdministrativa

' RELACIONES  

Usuario "1" -- "0..*" Transaccion : realiza
Material "1" -- "0..*" Transaccion : involucrado
Prestamo "1" -- "0..*" Multa : genera
Usuario "1" -- "0..*" Multa : tiene
MultaPorDano "1" *-- "1..*" Dano : contiene

' EXCEPCIONES 


class BibliotecaException <<exception>> {
    -string mensaje
    -string codigo
    +GetMensaje() : string
    +GetCodigo() : string
}

class MaterialNoDisponibleException <<exception>> {
    -string idMaterial
    -EstadoMaterial estadoActual
    -DateTime fechaDisponibilidadEstimada
    +GetIdMaterial() : string
    +GetEstadoActual() : EstadoMaterial
}

class UsuarioBloqueadoException <<exception>> {
    -string idUsuario
    -List<string> motivosBloqueo
    -decimal multaPendiente
    +GetIdUsuario() : string
    +GetMotivos() : List<string>
}

class LimiteExcedidoException <<exception>> {
    -string idUsuario
    -int limiteMaximo
    -int cantidadActual
    +GetLimiteMaximo() : int
}

class MaterialNoEncontradoException <<exception>> {
    -string idMaterial
    +GetIdMaterial() : string
}

class OperacionNoPermitidaException <<exception>> {
    -string operacion
    +GetOperacion() : string
}

BibliotecaException <|-- MaterialNoDisponibleException
BibliotecaException <|-- UsuarioBloqueadoException
BibliotecaException <|-- LimiteExcedidoException
BibliotecaException <|-- MaterialNoEncontradoException
BibliotecaException <|-- OperacionNoPermitidaException


' INTERFACES 

interface IDisponibilidadService {
    +VerificarDisponibilidad(idMaterial : string) : bool
    +ObtenerEstadoActual(idMaterial : string) : EstadoMaterial
    +MaterialEsPrestable(idMaterial : string, tipoMaterial : TipoMaterial) : bool
}

interface ILimitePrestamoService {
    +ValidarLimite(idUsuario : string, tipoUsuario : TipoUsuario) : ResultadoValidacion
    +ObtenerLimiteMaximo(tipoUsuario : TipoUsuario) : int
    +CantidadActualPrestada(idUsuario : string) : int
}

interface IValidadorReglasService {
    +ValidarPrestamo(idUsuario : string, idMaterial : string) : ResultadoValidacion
    +ValidarReserva(idUsuario : string, idMaterial : string) : ResultadoValidacion
    +ValidarRenovacion(idPrestamo : string) : ResultadoValidacion
}

interface IPoliticaTiempoService {
    +CalcularDiasPrestamo(tipoMaterial : TipoMaterial, tipoUsuario : TipoUsuario) : int
    +ObtenerFechaDevolucion(fechaPrestamo : DateTime, tipoMaterial : TipoMaterial, tipoUsuario : TipoUsuario) : DateTime
}

interface IGestorBloqueoService {
    +VerificarSiDebeBloquear(idUsuario : string) : ResultadoValidacion
    +BloquearUsuario(idUsuario : string, motivo : string) : Resultado
    +DesbloquearUsuario(idUsuario : string) : Resultado
}

interface IReservaService {
    +CrearReserva(idUsuario : string, idMaterial : string, tipoReserva : string) : Resultado
    +CancelarReserva(idReserva : string) : Resultado
    +NotificarDisponibilidad(idReserva : string) : Resultado
}

interface IRenovacionService {
    +ValidarRenovacion(idPrestamo : string) : ResultadoValidacion
    +RenovarPrestamo(idPrestamo : string) : Resultado
    +ObtenerRenovacionesDisponibles(idPrestamo : string, tipoUsuario : TipoUsuario) : int
}

interface IPrestamoService {
    +RegistrarPrestamo(idUsuario : string, idMaterial : string, tipoPrestamo : string) : Resultado
    +ObtenerPrestamosActivos(idUsuario : string) : List<Prestamo>
}

interface IDevolucionService {
    +RegistrarDevolucion(idPrestamo : string, evaluacion : Evaluacion) : Resultado
}

interface IInspeccionMaterialService {
    +InspeccionarMaterial(idMaterial : string) : Evaluacion
}

interface INotificacionService {
    +EnviarNotificacion(idUsuario : string, mensaje : string) : Resultado
}

' CALCULADORES DE MULTA

interface ICalculadorMulta {
    +Calcular(contexto) : Multa
    +PuedeCalcular(contexto) : bool
}

class CalculadorMultaPorRetraso <<service>> {
    -IRepositorio<Prestamo> repoPrestamo
    -Map<TipoMaterial, decimal> tarifasPorTipo
    +Calcular(contexto) : Multa
    +PuedeCalcular(contexto) : bool
    -CalcularDiasRetraso(prestamo : Prestamo, fechaActual : DateTime) : int
    -ObtenerTarifa(tipoMaterial : TipoMaterial) : decimal
}

class CalculadorMultaPorDano <<service>> {
    -ICalculadorCostoDanoService calculadorCosto
    +Calcular(contexto) : Multa
    +PuedeCalcular(contexto) : bool
}

class CalculadorMultaPorPerdida <<service>> {
    -IRepositorio<Material> repoMaterial
    -decimal PORCENTAJE_RECARGO
    +Calcular(contexto) : Multa
    +PuedeCalcular(contexto) : bool
}

class CalculadorMultaAdministrativa <<service>> {
    +Calcular(contexto) : Multa
    +PuedeCalcular(contexto) : bool
}

ICalculadorMulta <|.. CalculadorMultaPorRetraso
ICalculadorMulta <|.. CalculadorMultaPorDano
ICalculadorMulta <|.. CalculadorMultaPorPerdida
ICalculadorMulta <|.. CalculadorMultaAdministrativa

' SERVICIO GESTOR DE MULTAS

class GestorMultasService <<service>> {
    -List<ICalculadorMulta> calculadores
    +RegistrarCalculador(calculador : ICalculadorMulta)
    +CalcularMulta(contexto : ContextoMulta) : Multa
}

GestorMultasService --> ICalculadorMulta : usa lista de

note right of GestorMultasService
  Orquestador que:
  1. Recibe contexto (tipo multa, datos)
  2. Busca calculador apropiado
  3. Delega el cálculo
  4. Retorna la multa creada
end note

' SERVICIO CALCULADOR DE COSTO DE DAÑO


interface ICalculadorCostoDanoService {
    +CalcularCosto(dano : Dano) : decimal
    +CalcularCostoTotal(danos : List<Dano>) : decimal
}

class CalculadorCostoDanoService <<service>> {
    -Map<TipoDano, Map<NivelGravedad, decimal>> tarifas
    +CalcularCosto(dano : Dano) : decimal
    +CalcularCostoTotal(danos : List<Dano>) : decimal
    -ObtenerTarifa(tipo : TipoDano, gravedad : NivelGravedad) : decimal
}

ICalculadorCostoDanoService <|.. CalculadorCostoDanoService

CalculadorMultaPorDano --> ICalculadorCostoDanoService : usa


class DisponibilidadStandardService <<service>> {
    -IRepositorio<Material> repoMaterial
    -IRepositorio<Prestamo> repoPrestamo
    -Set<TipoMaterial> materialesNoPrestables
    +VerificarDisponibilidad(idMaterial : string) : bool
    +MaterialEsPrestable(idMaterial : string, tipoMaterial : TipoMaterial) : bool
}

class LimitePorTipoUsuarioService <<service>> {
    -IRepositorio<Usuario> repoUsuario
    -IRepositorio<Prestamo> repoPrestamo
    -Map<TipoUsuario, int> limitesPorTipo
    +ValidarLimite(idUsuario : string, tipoUsuario : TipoUsuario) : ResultadoValidacion
    +ObtenerLimiteMaximo(tipoUsuario : TipoUsuario) : int
}

class ValidadorReglasService <<service>> {
    -ILimitePrestamoService limiteService
    -IDisponibilidadService disponibilidadService
    -IGestorBloqueoService bloqueoService
    -List<IReglaValidacion> reglas
    +ValidarPrestamo(idUsuario : string, idMaterial : string) : ResultadoValidacion
}

class PoliticaTiempoPorTipoService <<service>> {
    -Map<TipoMaterial, Map<TipoUsuario, int>> politicas
    +CalcularDiasPrestamo(tipoMaterial : TipoMaterial, tipoUsuario : TipoUsuario) : int
    +ObtenerFechaDevolucion(fechaPrestamo : DateTime, tipoMaterial : TipoMaterial, tipoUsuario : TipoUsuario) : DateTime
}

class GestorBloqueoService <<service>> {
    -IRepositorio<Usuario> repoUsuario
    -IRepositorio<Multa> repoMulta
    -decimal UMBRAL_BLOQUEO
    +VerificarSiDebeBloquear(idUsuario : string) : ResultadoValidacion
    +BloquearUsuario(idUsuario : string, motivo : string) : Resultado
}

class RenovacionService <<service>> {
    -IRepositorio<Prestamo> repoPrestamo
    -IRepositorio<Reserva> repoReserva
    -IValidadorReglasService validador
    -IPoliticaTiempoService politicaTiempo
    -Map<TipoUsuario, int> maximoRenovaciones
    +ValidarRenovacion(idPrestamo : string) : ResultadoValidacion
    +RenovarPrestamo(idPrestamo : string) : Resultado
}

class ReservaService <<service>> {
    -IRepositorio<Reserva> repoReserva
    -IRepositorio<Material> repoMaterial
    -IDisponibilidadService disponibilidad
    -IValidadorReglasService validador
    -INotificacionService notificador
    +CrearReserva(idUsuario : string, idMaterial : string, tipoReserva : string) : Resultado
}

class PrestamoService <<service>> {
    -IValidadorReglasService validador
    -IDisponibilidadService disponibilidad
    -IPoliticaTiempoService politicaTiempo
    -IRepositorio<Prestamo> repoPrestamo
    -IRepositorio<Material> repoMaterial
    -IRepositorio<Usuario> repoUsuario
    -INotificacionService notificador
    +RegistrarPrestamo(idUsuario : string, idMaterial : string, tipoPrestamo : string) : Resultado
}

class DevolucionService <<service>> {
    -IInspeccionMaterialService inspeccion
    -GestorMultasService gestorMultas
    -IRepositorio<Prestamo> repoPrestamo
    -IRepositorio<Material> repoMaterial
    -IRepositorio<Usuario> repoUsuario
    -IReservaService reservas
    -INotificacionService notificador
    -IGestorBloqueoService gestorBloqueo
    +RegistrarDevolucion(idPrestamo : string, evaluacion : Evaluacion) : Resultado
}

class InspeccionMaterialService <<service>> {
    -IRepositorio<Material> repoMaterial
    +InspeccionarMaterial(idMaterial : string) : Evaluacion
}

class NotificacionEmailService <<service>> {
    -string servidorSMTP
    +EnviarNotificacion(idUsuario : string, mensaje : string) : Resultado
}

' RELACIONES IMPLEMENTACIONES


IDisponibilidadService <|.. DisponibilidadStandardService
ILimitePrestamoService <|.. LimitePorTipoUsuarioService
IValidadorReglasService <|.. ValidadorReglasService
IPoliticaTiempoService <|.. PoliticaTiempoPorTipoService
IGestorBloqueoService <|.. GestorBloqueoService
IRenovacionService <|.. RenovacionService
IReservaService <|.. ReservaService
IPrestamoService <|.. PrestamoService
IDevolucionService <|.. DevolucionService
IInspeccionMaterialService <|.. InspeccionMaterialService
INotificacionService <|.. NotificacionEmailService

ValidadorReglasService --> ILimitePrestamoService : usa
ValidadorReglasService --> IDisponibilidadService : usa
ValidadorReglasService --> IGestorBloqueoService : usa

RenovacionService --> IValidadorReglasService : usa
RenovacionService --> IPoliticaTiempoService : usa

ReservaService --> IDisponibilidadService : usa
ReservaService --> IValidadorReglasService : usa
ReservaService --> INotificacionService : usa

PrestamoService --> IValidadorReglasService : usa
PrestamoService --> IDisponibilidadService : usa
PrestamoService --> IPoliticaTiempoService : usa
PrestamoService --> INotificacionService : usa

DevolucionService --> IInspeccionMaterialService : usa
DevolucionService --> GestorMultasService : usa
DevolucionService --> IReservaService : usa
DevolucionService --> INotificacionService : usa
DevolucionService --> IGestorBloqueoService : usa

DisponibilidadStandardService ..> TipoMaterial : lee tipo
LimitePorTipoUsuarioService ..> TipoUsuario : lee tipo
PoliticaTiempoPorTipoService ..> TipoMaterial : lee tipo
PoliticaTiempoPorTipoService ..> TipoUsuario : lee tipo
CalculadorMultaPorRetraso ..> TipoMaterial : lee tipo

DisponibilidadStandardService ..> MaterialNoDisponibleException : lanza
LimitePorTipoUsuarioService ..> LimiteExcedidoException : lanza
GestorBloqueoService ..> UsuarioBloqueadoException : lanza
RenovacionService ..> OperacionNoPermitidaException : lanza

LimitePorTipoUsuarioService ..> ResultadoValidacion : retorna
ValidadorReglasService ..> ResultadoValidacion : retorna
GestorBloqueoService ..> ResultadoValidacion : retorna
RenovacionService ..> ResultadoValidacion : retorna

PrestamoService ..> Resultado : retorna
DevolucionService ..> Resultado : retorna
ReservaService ..> Resultado : retorna
RenovacionService ..> Resultado : retorna
NotificacionEmailService ..> Resultado : retorna

CalculadorMultaPorRetraso ..> MultaPorRetraso : crea
CalculadorMultaPorDano ..> MultaPorDano : crea
CalculadorMultaPorPerdida ..> MultaPorPerdida : crea
CalculadorMultaAdministrativa ..> MultaAdministrativa : crea

InspeccionMaterialService ..> Evaluacion : retorna

' REGLAS DE VALIDACIÓN

interface IReglaValidacion {
    +Validar(contexto) : ResultadoValidacion
    +ObtenerPrioridad() : int
}

class ReglaUsuarioActivo {
    +Validar(contexto) : ResultadoValidacion
    +ObtenerPrioridad() : int
}

class ReglaMaterialDisponible {
    +Validar(contexto) : ResultadoValidacion
    +ObtenerPrioridad() : int
}

class ReglaLimiteNoExcedido {
    -ILimitePrestamoService limiteService
    +Validar(contexto) : ResultadoValidacion
    +ObtenerPrioridad() : int
}

IReglaValidacion <|.. ReglaUsuarioActivo
IReglaValidacion <|.. ReglaMaterialDisponible
IReglaValidacion <|.. ReglaLimiteNoExcedido

ValidadorReglasService --> IReglaValidacion : usa lista
ReglaLimiteNoExcedido --> ILimitePrestamoService : usa

' REPOSITORIOS


interface "IRepositorio<T>" as IRepositorio {
    +Agregar(entidad : T) : Resultado
    +Actualizar(entidad : T) : Resultado
    +Eliminar(id : string) : Resultado
    +ObtenerPorId(id : string) : T
    +ObtenerTodos() : List<T>
    +Existe(id : string) : bool
}

class "RepositorioEnMemoria<T>" as RepositorioEnMemoria {
    -Dictionary<string, T> almacenamiento
    +Agregar(entidad : T) : Resultado
    +ObtenerPorId(id : string) : T
    +ObtenerTodos() : List<T>
}

IRepositorio <|.. RepositorioEnMemoria

' ========================================
' REPOSITORIOS ESPECÍFICOS
' ========================================

class RepositorioMaterialEnMemoria {
    -Dictionary<string, Material> almacenamiento
    +Agregar(entidad : Material) : Resultado
    +Actualizar(entidad : Material) : Resultado
    +Eliminar(id : string) : Resultado
    +ObtenerPorId(id : string) : Material
    +ObtenerTodos() : List<Material>
    +Existe(id : string) : bool
    +BuscarPorTitulo(titulo : string) : List<Material>
    +BuscarPorAutor(autor : string) : List<Material>
    +ObtenerDisponibles() : List<Material>
}

class RepositorioUsuarioEnMemoria {
    -Dictionary<string, Usuario> almacenamiento
    +Agregar(entidad : Usuario) : Resultado
    +Actualizar(entidad : Usuario) : Resultado
    +Eliminar(id : string) : Resultado
    +ObtenerPorId(id : string) : Usuario
    +ObtenerTodos() : List<Usuario>
    +Existe(id : string) : bool
    +BuscarPorEmail(email : string) : Usuario
    +ObtenerActivos() : List<Usuario>
    +ObtenerBloqueados() : List<Usuario>
}

class RepositorioPrestamoEnMemoria {
    -Dictionary<string, Prestamo> almacenamiento
    +Agregar(entidad : Prestamo) : Resultado
    +Actualizar(entidad : Prestamo) : Resultado
    +Eliminar(id : string) : Resultado
    +ObtenerPorId(id : string) : Prestamo
    +ObtenerTodos() : List<Prestamo>
    +Existe(id : string) : bool
    +ObtenerPrestamosActivos(idUsuario : string) : List<Prestamo>
    +ObtenerPrestamosVencidos() : List<Prestamo>
    +ObtenerHistorial(idUsuario : string) : List<Prestamo>
    +ObtenerPorMaterial(idMaterial : string) : List<Prestamo>
}

class RepositorioReservaEnMemoria {
    -Dictionary<string, Reserva> almacenamiento
    +Agregar(entidad : Reserva) : Resultado
    +Actualizar(entidad : Reserva) : Resultado
    +Eliminar(id : string) : Resultado
    +ObtenerPorId(id : string) : Reserva
    +ObtenerTodos() : List<Reserva>
    +Existe(id : string) : bool
    +ObtenerReservasPorMaterial(idMaterial : string) : List<Reserva>
    +ObtenerReservasPendientes(idUsuario : string) : List<Reserva>
    +ObtenerSiguienteEnCola(idMaterial : string) : Reserva
}

class RepositorioMultaEnMemoria {
    -Dictionary<string, Multa> almacenamiento
    +Agregar(entidad : Multa) : Resultado
    +Actualizar(entidad : Multa) : Resultado
    +Eliminar(id : string) : Resultado
    +ObtenerPorId(id : string) : Multa
    +ObtenerTodos() : List<Multa>
    +Existe(id : string) : bool
    +ObtenerMultasPendientes(idUsuario : string) : List<Multa>
    +CalcularTotalAdeudado(idUsuario : string) : decimal
    +ObtenerPorPrestamo(idPrestamo : string) : List<Multa>
}

"IRepositorio<Material>" <|.. RepositorioMaterialEnMemoria
"IRepositorio<Usuario>" <|.. RepositorioUsuarioEnMemoria
"IRepositorio<Prestamo>" <|.. RepositorioPrestamoEnMemoria
"IRepositorio<Reserva>" <|.. RepositorioReservaEnMemoria
"IRepositorio<Multa>" <|.. RepositorioMultaEnMemoria

note right of RepositorioMaterialEnMemoria
  Repositorios específicos con
  métodos adicionales especializados.
  
  Cada uno implementa IRepositorio<T>
  y agrega consultas propias del dominio.
end note

' OBJETOS DE VALOR Y RESULTADOS

class ResultadoValidacion {
    -bool esValido
    -List<string> errores
    -List<string> advertencias
    +EsValido() : bool
    +GetErrores() : List<string>
    +Combinar(otro : ResultadoValidacion) : ResultadoValidacion
    +{static} Valido() : ResultadoValidacion
    +{static} Invalido(errores : List<string>) : ResultadoValidacion
}

class Resultado {
    -bool exito
    -string mensaje
    -object data
    +GetExito() : bool
    +GetMensaje() : string
    +GetData() : object
    +{static} Exitoso(mensaje : string, data : object) : Resultado
    +{static} Fallido(mensaje : string) : Resultado
}

class Evaluacion {
    -bool materialUsable
    -List<Dano> danosEncontrados
    +EsUsable() : bool
    +GetDanos() : List<Dano>
}

class Dano {
    -string descripcion
    -NivelGravedad gravedad
    -TipoDano tipo
    +GetDescripcion() : string
    +GetGravedad() : NivelGravedad
    +GetTipo() : TipoDano
}

Evaluacion "1" *-- "0..*" Dano : contiene

class ContextoMulta {
    -string idPrestamo
    -string idMaterial
    -string idUsuario
    -DateTime fechaActual
    -Evaluacion evaluacion
    -TipoMulta tipoMulta
    +GetIdPrestamo() : string
    +GetTipoMulta() : TipoMulta
}

GestorMultasService ..> ContextoMulta : recibe

' ENUMS


enum TipoMaterial {
    LIBRO_NORMAL
    LIBRO_BESTSELLER
    LIBRO_REFERENCIA
    DVD
    REVISTA
    EBOOK
}

enum TipoUsuario {
    ESTUDIANTE
    PROFESOR
    INVESTIGADOR
    PUBLICO_GENERAL
}

enum TipoMulta {
    POR_RETRASO
    POR_DANO
    POR_PERDIDA
    ADMINISTRATIVA
}

enum EstadoMaterial {
    DISPONIBLE
    PRESTADO
    RESERVADO
    EN_REPARACION
    PERDIDO
}

enum EstadoUsuario {
    ACTIVO
    BLOQUEADO_MULTA
    BLOQUEADO_PERDIDA
    SUSPENDIDO
}

enum EstadoTransaccion {
    ACTIVA
    COMPLETADA
    CANCELADA
}

enum EstadoMulta {
    PENDIENTE
    PAGADA
    CONDONADA
}

enum NivelGravedad {
    LEVE
    MODERADO
    GRAVE
    IRREPARABLE
}

enum TipoDano {
    PAGINAS_RASGADAS
    MANCHAS
    CUBIERTA_DANADA
    RAYONES
    NO_FUNCIONAL
}

Material --> TipoMaterial : tiene
Usuario --> TipoUsuario : tiene
Dano --> NivelGravedad : tiene
Dano --> TipoDano : clasifica
ContextoMulta --> TipoMulta : especifica

@enduml

